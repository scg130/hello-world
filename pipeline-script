node("jnlp"){
    stage("clone"){
        sh 'cd /home/jenkins/go/src'
        checkout([$class: 'GitSCM', branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[credentialsId: 'github-auth', url: 'https://github.com/scg130/hello-world.git']]])
        sh 'ls -al'
    }
    stage("test"){
        echo 'go test'
        sh 'make test'
    }
    stage("build"){
        sh 'make build'
        script{
            def tag = sh returnStdout: true, script: 'git rev-parse --short HEAD'
            tag = tag.trim()
            sh "make docker tag=${tag}"
            withCredentials([usernamePassword(credentialsId: 'hub-docker', passwordVariable: 'passwd', usernameVariable: 'user')]) {
                sh "make push user=$user pwd=$passwd tag=$tag"
            }
        }
    }
    stage("deploy"){
        echo "deploy"
        script{
            def tag = sh returnStdout: true, script: 'git rev-parse --short HEAD'
            tag = tag.trim()
            sh "sed -i 's/<BUILD_TAG>/${tag}/' k8s.yml"
            sh "cat k8s.yml"
        }
    }
}